<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>MV STUDIO - VARIANTA FUNCȚIONALĂ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <style>
        :root { --main-color: #ffaa00; --pulse: 1; }
        body { background: #000; color: white; margin: 0; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        #viewport { position: relative; width: 100vw; height: 100vh; background: #000; }
        #bg-video, #bg-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; display: none; }

        /* ELEMENTE MOBILE */
        .drag { position: absolute; cursor: move; z-index: 10; }
        #webcam-layer { top: 20px; right: 20px; width: 400px; transform: scale(1); }
        #ai-canvas { width: 100%; border-radius: 10px; background: rgba(0,0,0,0.2); }

        #circle-group { top: 20%; left: 35%; width: 450px; height: 450px; display: flex; align-items: center; justify-content: center; }
        #radial-canvas { position: absolute; }
        #inner-circle { width: 160px; height: 160px; border-radius: 50%; border: 6px solid var(--main-color); overflow: hidden; z-index: 11; background: #000; position: relative; }
        #inner-img { width: 100%; height: 100%; object-fit: cover; display: none; }

        /* TEXT ALB LIBER */
        #text-box { 
            bottom: 150px; left: 50px; font-size: 50px; font-weight: 900; color: white;
            text-shadow: 3px 3px 15px rgba(0,0,0,0.9); white-space: nowrap; z-index: 20; 
        }

        /* CONTROL JOS */
        .ui-container { position: fixed; bottom: 0; left: 0; width: 100%; display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; background: #111; padding: 10px; z-index: 1000; border-top: 3px solid var(--main-color); }
        .cube { background: #1a1a1a; padding: 8px; border: 1px solid #333; text-align: center; border-radius: 5px; font-size: 11px; }
        button { background: #333; width: 100%; padding: 6px; margin-top: 5px; font-weight: bold; border-radius: 4px; color: white; }
        .btn-green { background: #15803d !important; }
    </style>
</head>
<body>

<div id="viewport">
    <video id="bg-video" autoplay loop muted playsinline></video>
    <img id="bg-img">
    <div id="webcam-layer" class="drag"><canvas id="ai-canvas"></canvas></div>
    <div id="circle-group" class="drag">
        <canvas id="radial-canvas" width="450" height="450"></canvas>
        <div id="inner-circle"><img id="inner-img" src=""></div>
    </div>
    <div id="text-box" class="drag">BINE AȚI VENIT!</div>
</div>

<div class="ui-container" id="main-ui">
    <div class="cube"><b>1. VIDEO</b><input type="file" onchange="loadM(this,'v')"></div>
    <div class="cube"><b>2. SLIDESHOW</b><input type="file" multiple onchange="loadM(this,'s')"></div>
    <div class="cube"><b>3. AI CAM</b><button onclick="startCam()" class="btn-green">START CAM</button><button onclick="isAI=!isAI">AI CUT</button></div>
    <div class="cube"><b>4. LOGO/VU</b><input type="file" onchange="loadM(this,'l')"></div>
    <div class="cube"><b>5. TEXT</b><input type="text" oninput="upTxt(this.value)"><input type="color" oninput="upCol(this.value)"></div>
    <div class="cube"><b>6. APP</b><button onclick="toggleUI()">ASCUNDE (H)</button><button onclick="location.reload()">RESET</button></div>
</div>

<video id="h-vid" style="display:none" autoplay muted playsinline></video>

<script>
    // 1. FIREBASE (TELECOMANDĂ)
    const fbConfig = { databaseURL: "https://felicitari-nunta-default-rtdb.firebaseio.com" };
    firebase.initializeApp(fbConfig);
    const db = firebase.database().ref('remote_control_cioko');

    db.on('value', (sn) => {
        const d = sn.val(); if (!d) return;
        if (d.text || d.val) upTxt(d.text || d.val);
        if (d.color) upCol(d.color);
        if (d.cmd === 'TOGGLE_SETUP_UI') toggleUI();
    });

    // 2. VARIABILE ȘI MEDIA
    let isAI = false, audioCtx, analyzer, dataArray, slideImgs = [], slideIdx = 0, slideInt = null;

    function loadM(input, type) {
        const files = Array.from(input.files);
        if (type === 'v') {
            document.getElementById('bg-video').src = URL.createObjectURL(files[0]);
            document.getElementById('bg-video').style.display = 'block';
            document.getElementById('bg-img').style.display = 'none';
        }
        if (type === 's') {
            slideImgs = files.map(f => URL.createObjectURL(f));
            document.getElementById('bg-img').src = slideImgs[0];
            document.getElementById('bg-img').style.display = 'block';
            document.getElementById('bg-video').style.display = 'none';
            if (slideInt) clearInterval(slideInt);
            slideInt = setInterval(() => {
                slideIdx = (slideIdx + 1) % slideImgs.length;
                document.getElementById('bg-img').src = slideImgs[slideIdx];
            }, 5000);
        }
        if (type === 'l') {
            document.getElementById('inner-img').src = URL.createObjectURL(files[0]);
            document.getElementById('inner-img').style.display = 'block';
        }
    }

    // 3. CAMERA AI ȘI VU-METER
    async function startCam() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('h-vid').srcObject = stream;
            
            // Audio setup
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const src = audioCtx.createMediaStreamSource(stream);
            analyzer = audioCtx.createAnalyser(); analyzer.fftSize = 256;
            dataArray = new Uint8Array(analyzer.frequencyBinCount);
            src.connect(analyzer);
            drawVu();

            // AI Setup
            const selfie = new SelfieSegmentation({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
            selfie.setOptions({modelSelection: 1});
            selfie.onResults(res => {
                const cv = document.getElementById('ai-canvas'), ctx = cv.getContext('2d');
                cv.width = res.image.width; cv.height = res.image.height;
                ctx.save(); ctx.clearRect(0,0,cv.width,cv.height);
                if(isAI) { ctx.drawImage(res.segmentationMask, 0, 0, cv.width, cv.height); ctx.globalCompositeOperation = 'source-in'; }
                ctx.drawImage(res.image, 0, 0, cv.width, cv.height); ctx.restore();
            });
            async function predict() { await selfie.send({image: document.getElementById('h-vid')}); requestAnimationFrame(predict); }
            predict();
        } catch (e) { alert("Eroare: " + e.message); }
    }

    function drawVu() {
        requestAnimationFrame(drawVu);
        if (!analyzer) return;
        analyzer.getByteFrequencyData(dataArray);
        const cv = document.getElementById('radial-canvas'), ctx = cv.getContext('2d');
        ctx.clearRect(0, 0, 450, 450);
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--main-color');
        ctx.lineWidth = 5;
        for (let i = 0; i < 60; i++) {
            const val = dataArray[i] * 0.5;
            const a = (i * 6) * Math.PI / 180;
            ctx.beginPath();
            ctx.moveTo(225 + Math.cos(a) * 90, 225 + Math.sin(a) * 90);
            ctx.lineTo(225 + Math.cos(a) * (90 + val), 225 + Math.sin(a) * (90 + val));
            ctx.stroke();
        }
    }

    // 4. DRAG LOGIC
    document.querySelectorAll('.drag').forEach(el => {
        let x = 0, y = 0;
        el.onmousedown = (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
            x = e.clientX; y = e.clientY;
            document.onmousemove = (ev) => {
                el.style.left = (el.offsetLeft - (x - ev.clientX)) + "px";
                el.style.top = (el.offsetTop - (y - ev.clientY)) + "px";
                x = ev.clientX; y = ev.clientY;
            };
            document.onmouseup = () => { document.onmousemove = null; };
        };
    });

    function upTxt(v) { document.getElementById('text-box').innerText = v; }
    function upCol(v) { document.documentElement.style.setProperty('--main-color', v); }
    function toggleUI() { 
        const u = document.getElementById('main-ui');
        u.style.display = (u.style.display === 'none' ? 'grid' : 'none'); 
    }
    document.addEventListener('keydown', e => { if(e.key.toLowerCase()==='h') toggleUI(); });
</script>
</body>
</html>
